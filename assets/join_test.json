[
    {"$join":
        {"$inner": {
            "root": "Customer",
            "args": [
                {"$derived": {
                    "entity": "Order",
                    "pipeline": [
                        {"$lookup": {"from": "orders", "localField": "customer_id", "foreignField": "_id", "as": "Customer.orders"}}
                    ]
                }},
                {"$left": {
                    "args": ["OrderItem"]
                }}
            ],
            "condition": {"$gt": ["$Order.total_amount", 500]}
        }}
    },
    {"$limit": 10},
    {"$skip": 0}
]
